---
title: Supplementary information to report "How to measure response diversity"
author: "Samuel R.P-J. Ross1, Owen L. Petchey, Takehiro Sasaki, David W. Armitage"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
---

```{r include = FALSE, echo = FALSE}
knitr::opts_chunk$set(include = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      echo = FALSE)
```

```{r}
rm(list = ls())
library(tidyverse)
library(patchwork)
library(ggtext)
library(mgcv)
library(gratia)
library(hypervolume)
library(here)

source(here("r/our_functions.r"))

```

# Introduction

To be written.

# Two dimensions of response diversity

A set of communities were created in which the species richness of the communities varied. Each of the $i$ species in a community was give a trait value, in this case the first derivative of it's response to an environmental variable ($x_i$).

```{r}
## Create the communities
num_spp <- c(2, 4, 8, 16)
max_minus_min <- round(seq(1, 15, length = 45),3)
mean <- round(seq(-10, 10, length = 49),3)
rd_vals <- function(num_spp, max_minus_min, mean) {
  seq(mean-max_minus_min/2, mean+max_minus_min/2, length = num_spp)
}
dd <- crossing(num_spp,
               max_minus_min,
               mean) %>%
  rowwise() %>%
  mutate(rd_vals = list(rd_vals(num_spp, max_minus_min, mean))) %>%
  unnest(cols = rd_vals)
```


The two dimensions (at least) of the response diversity of these values are:

* The spread of the distribution. Here we use the range ($range(x_i) = max(x_i) - min(x_i)$), which is equivalent to the convex hull volume in 1 dimension. Convex hull volume is a commonly used measure of trait diversity. The range is independent of the extent of overlap of the range with zero.

* To quantify the overlap with zero, we use  $\frac{abs( abs(max(x_i)) - abs(min(x_i)) ) - range(x_i) }{ range(x_i)}$. This quantity is zero when there is no overlap with zero, and is 1 when $min(x_i) = -max(x_i)$. 


```{r}
## Set which measure of response diversity used
rd_stat <- "range"
```

```{r}
## calculate the diversity metrics
summary_stats <- dd %>%
  group_by(num_spp, max_minus_min, mean) %>%
  summarise(range = resp_div(rd_vals, stat = rd_stat, sign_sens = FALSE),
            #cv = sd/mean(rd_vals),
            #cv_abs = sd/abs(mean(rd_vals)),
            #sd_abs_vals = sd(abs(rd_vals)),
            sign_sensitive_range = resp_div(rd_vals, stat = rd_stat, sign_sens = TRUE)) %>%
  pivot_longer(names_to = "variable", values_to = "value", 4:5)

## wrangle the data for easier plotting
all_data <- dd %>%
  mutate(variable = "first_deriv_vals",
         value = rd_vals) %>%
  select(-rd_vals) %>%
  bind_rows(summary_stats) %>%
  mutate(variable = as_factor(variable))
```

## Communities varying only in spread



(ref:XXX6) Communities varying only in the range of trait values. Trait values overlap zero. but the extent of overlap is constant, number of species is constant, and mean trait value is constant. Each column of dots corresponds to one community. Top panel shows the values of the first derivative of each of the species in the community. Bottom panel is the measure of overlap with zero.

```{r XXX6,  include=TRUE, fig.cap='(ref:XXX6)', fig.align="center", fig.height=4, fig.width=4}
this_mean <- 0
this_num_spp <- 8
all_data %>%
  filter(mean == this_mean,
         num_spp == this_num_spp,
         variable != "range") %>%
  ggplot(aes(x = max_minus_min, y = value)) +
  geom_point() +
  geom_hline(yintercept = 0, lty="dashed") +
  facet_wrap( ~ variable, scales = "free_y", ncol = 1) +
  xlab("Range of first derivative values in community") 



```

(ref:XXX7) Communities varying only in the range of trait values, with no overlap of trait values with zero. Extent of overlap of trait values with zero is constant, number of species is constant and mean trait value is constant. All else is as in the previous figure.

```{r XXX7,  include=TRUE, fig.cap='(ref:XXX7)', fig.align="center", fig.height=4, fig.width=4}
this_mean <- 2.5
this_num_spp <- 8
all_data %>%
  filter(mean == this_mean,
         num_spp == this_num_spp,
         max_minus_min < 5,
         variable != "range") %>%
  ggplot(aes(x = max_minus_min, y = value)) +
  geom_point() +
  geom_hline(yintercept = 0, lty="dashed") +
  facet_wrap( ~ variable, scales = "free_y", ncol = 1) +
  xlab("Range of first derivative values in community")
```


## Communities varying only in overlap

Here we look at communities that only vary in the overlap of trait values with zero, and that do not differ in range. The measure of the overlap with zero is zero while there is not overlap, then increases to a maximum when the mean is zero, and then decreases again (Fig. \@ref(fig:XXX8).

(ref:XXX8) Communities varying only in the mean trait value, but not in range of trait values or the number of species.

```{r XXX8,  include=TRUE, fig.cap='(ref:XXX8)', fig.align="center", fig.height=4, fig.width=4}
this_max_minus_min <- 5.455
this_num_spp <- 8
all_data %>%
  filter(max_minus_min == this_max_minus_min,
         num_spp == this_num_spp,
         variable != "range") %>%
  ggplot(aes(x = mean, y = value)) +
  geom_point() +
  geom_hline(yintercept = 0, lty="dashed") +
  facet_wrap( ~ variable, scales = "free_y", ncol = 1) +
  xlab("Mean of first derivative values in community") 
```




## Communities varying in both spread and overlap

(ref:XXX9) Communities varying both the range and the amount of overlap, but with constant mean trait value.

```{r XXX9,  include=TRUE, fig.cap='(ref:XXX9)', fig.align="center", fig.height=4, fig.width=4}
this_mean <- 2.5
this_num_spp <- 8
all_data %>%
  filter(mean == this_mean,
         num_spp == this_num_spp,
         variable != "range") %>%
  ggplot(aes(x = max_minus_min, y = value)) +
  geom_point() +
  geom_hline(yintercept = 0, lty="dashed") +
  facet_wrap( ~ variable, scales = "free_y", ncol = 1) +
  xlab("Range of first derivative values in community")
```

## Varying number of species

When only number of species varies, neither of the response diversity measures changes.

(ref:XXX10) Communities with different numbers of species, but same range of trait values, same amount of overlap with zero, and same mean trait values.

```{r XXX10,  include=TRUE, fig.cap='(ref:XXX10)', fig.align="center", fig.height=4, fig.width=4}
this_mean <- 0
this_num_spp <- 8
this_max_minus_min <- 5.455
all_data %>%
  filter(mean == this_mean,
         max_minus_min == this_max_minus_min,
         variable != "range") %>%
  ggplot(aes(x = num_spp, y = value)) +
  geom_point() +
  geom_hline(yintercept = 0, lty="dashed") +
  facet_wrap( ~ variable, scales = "free_y", ncol = 1) +
  xlab("Number of species") 
```

# Producing Figures 2-3 based on simulated data

This section will produce Figures 2-3 from the manuscript. The figures are inspired by a range of examples from the literature (see main text), but are based on simulated data.

First, we'll generate a series of simulated communities that have high, medium, or low response diversity to an environmental variable [x], based on correlated or uncorrelated responses, and responding either linearly or nonlinearly.

```{r}
# generate an environmental variable (x), as a simple sequence of numbers
x = seq(0, 1, length.out = 100)

# generate species with different responses to the environment 
# Linear responses:
y1a <- 0.8-1*x; y2a <- 0.75-1* x; y3a <-0.85-1*x # responses are similar in direction and magnitude (low response diversity)
y1b <- 0.5-0.2*x; y2b <- 0.75-1*x; y3b <-1-2.5*x # responses are similar in direction but not magnitude (medium response diversity)
y1c <- 0.6-0.75*x; y2c <- rev(y1c); y3c <- rep(0.35, length(x)) # responses are not similar in direction or magnitude (high response diversity)

# Nonlinear responses:
y1d <- range01(dnorm(x,0.5,0.3)); y2d <- range01(dnorm(x,0.475,0.3)); y3d <- range01(dnorm(x,0.525,0.3)) # responses are similar in direction and magnitude (low response diversity)
y1e <- range01(dnorm(x,0.5,0.3)); y2e <- range01(dnorm(x,0.2,0.3)); y3e <- range01(dnorm(x,0.8,0.3)) # responses are similar in direction but not magnitude (medium response diversity)
y1f <- exp(-3*x); y2f <- rev(y1f); y3f <- 1-(y1f+y2f) # responses are not similar in direction or magnitude (high response diversity)
```

We'll model these species-environment relationships using generalized additive models (GAMs).

```{r}
# model individual species~environment relationships using GAM
m1a <- gam(y1a~s(x)); m2a <- gam(y2a~s(x)); m3a <- gam(y3a~s(x))
m1b <- gam(y1b~s(x)); m2b <- gam(y2b~s(x)); m3b <- gam(y3b~s(x))
m1c <- gam(y1c~s(x)); m2c <- gam(y2c~s(x)); m3c <- gam(y3c~s(x))
m1d <- gam(y1d~s(x)); m2d <- gam(y2d~s(x)); m3d <- gam(y3d~s(x))
m1e <- gam(y1e~s(x)); m2e <- gam(y2e~s(x)); m3e <- gam(y3e~s(x))
m1f <- gam(y1f~s(x)); m2f <- gam(y2f~s(x)); m3f <- gam(y3f~s(x))
```

Then we calculate the first derivatives of these relationships.

```{r}
# calculate first derivatives from models
d1a <- derivatives(m1a); d2a <- derivatives(m2a); d3a <- derivatives(m3a)
d1b <- derivatives(m1b); d2b <- derivatives(m2b); d3b <- derivatives(m3b)
d1c <- derivatives(m1c); d2c <- derivatives(m2c); d3c <- derivatives(m3c)
d1d <- derivatives(m1d); d2d <- derivatives(m2d); d3d <- derivatives(m3d)
d1e <- derivatives(m1e); d2e <- derivatives(m2e); d3e <- derivatives(m3e)
d1f <- derivatives(m1f); d2f <- derivatives(m2f); d3f <- derivatives(m3f)
```

Then we'll measure response diversity using the approach above. 

```{r}

# calculate response diversity for model a
rdiv_a<-data.frame('data' = d1a$data, 'sp.1' = d1a$derivative, 'sp.2' = d2a$derivative, 'sp.3' = d3a$derivative)
rdiv_a$rdiv<-apply(rdiv_a[,c(2:4)], 1, resp_div, stat = "range", sign_sens = F)
rdiv_a$sign<-apply(rdiv_a[,c(2:4)], 1, resp_div, stat = "range", sign_sens = T)
rdiv_a$Med<-median(rdiv_a$rdiv)

# calculate response diversity for model b
rdiv_b<-data.frame('data' = d1b$data, 'sp.1' = d1b$derivative, 'sp.2' = d2b$derivative, 'sp.3' = d3b$derivative)
rdiv_b$rdiv<-apply(rdiv_b[,c(2:4)], 1, resp_div, stat = "range", sign_sens = F)
rdiv_b$sign<-apply(rdiv_b[,c(2:4)], 1, resp_div, stat = "range", sign_sens = T)
rdiv_b$Med<-median(rdiv_b$rdiv)

# calculate response diversity for model c
rdiv_c<-data.frame('data' = d1c$data, 'sp.1' = d1c$derivative, 'sp.2' = d2c$derivative, 'sp.3' = d3c$derivative)
rdiv_c$rdiv<-apply(rdiv_c[,c(2:4)], 1, resp_div, stat = "range", sign_sens = F)
rdiv_c$sign<-apply(rdiv_c[,c(2:4)], 1, resp_div, stat = "range", sign_sens = T)
rdiv_c$Med<-median(rdiv_c$rdiv)

# calculate response diversity for model d
rdiv_d<-data.frame('data' = d1d$data, 'sp.1' = d1d$derivative, 'sp.2' = d2d$derivative, 'sp.3' = d3d$derivative)
rdiv_d$rdiv<-apply(rdiv_d[,c(2:4)], 1, resp_div, stat = "range", sign_sens = F)
rdiv_d$sign<-apply(rdiv_d[,c(2:4)], 1, resp_div, stat = "range", sign_sens = T)
rdiv_d$Med<-median(rdiv_d$rdiv)

# calculate response diversity for model e
rdiv_e<-data.frame('data' = d1e$data, 'sp.1' = d1e$derivative, 'sp.2' = d2e$derivative, 'sp.3' = d3e$derivative)
rdiv_e$rdiv<-apply(rdiv_e[,c(2:4)], 1, resp_div, stat = "range", sign_sens = F)
rdiv_e$sign<-apply(rdiv_e[,c(2:4)], 1, resp_div, stat = "range", sign_sens = T)
rdiv_e$Med<-median(rdiv_e$rdiv)

# calculate response diversity for model f
rdiv_f<-data.frame('data' = d1f$data, 'sp.1' = d1f$derivative, 'sp.2' = d2f$derivative, 'sp.3' = d3f$derivative)
rdiv_f$rdiv<-apply(rdiv_f[,c(2:4)], 1, resp_div, stat = "range", sign_sens = F)
rdiv_f$sign<-apply(rdiv_f[,c(2:4)], 1, resp_div, stat = "range", sign_sens = T)
rdiv_f$Med<-median(rdiv_f$rdiv)

```

Now we have all the data required to produce the figures from the manuscript. First, we'll produce *Figure 2*, which looks at linear performance-environment relationships: 

```{r}
# Y value range
ymax<-max(y1a,y2a,y3a,y1b,y2b,y3b,y1c,y2c,y3c);ymin<-min(y1a,y2a,y3a,y1b,y2b,y3b,y1c,y2c,y3c)
dmax<-max(d1a$derivative,d2a$derivative,d3a$derivative,d1b$derivative,d2b$derivative,d3b$derivative,d1c$derivative,d2c$derivative,d3c$derivative)
dmin<-min(d1a$derivative,d2a$derivative,d3a$derivative,d1b$derivative,d2b$derivative,d3b$derivative,d1c$derivative,d2c$derivative,d3c$derivative)
rmax<-max(rdiv_a$rdiv,rdiv_b$rdiv,rdiv_c$rdiv);rmin<-0
smax<-1;smin<-0

# panel a
Fig_2a<-ggplot(data = NULL,mapping = aes(x = x,y = y1a)) +
  theme_classic(base_size = 14) + 
  labs(x = "Spring frost",y = "Chlorophyll production",title = "Low response diversity",tag = "a)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = y2a),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = y3a),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(ymin,ymax))

# panel b
Fig_2b<-ggplot(data = NULL,mapping = aes(x = x,y = y1b)) +
  theme_classic(base_size = 14) + 
  labs(x = "Urbanisation",y = "Macroinvertebrate abundance",title = "Medium response diversity",tag = "b)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = y2b),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = y3b),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(ymin,ymax))

# panel c
Fig_2c<-ggplot(data = NULL,mapping = aes(x = x,y = y1c)) +
  theme_classic(base_size = 14) + 
  labs(x = "Winter temperature",y = "Bee mass loss",title = "High response diversity",tag = "c)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = y2c),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = y3c),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(ymin,ymax))

# panel d
Fig_2d<-ggplot(data = NULL,mapping = aes(x = d1a$data,y = d1a$derivative)) +
  theme_classic(base_size = 14) + 
  labs(x = "Spring frost",y = "Derivative (chlorophyll product.)",tag = "d)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = d2a$derivative),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = d3a$derivative),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(dmin,dmax))

# panel e
Fig_2e<-ggplot(data = NULL,mapping = aes(x = d1b$data,y = d1b$derivative)) +
  theme_classic(base_size = 14) + 
  labs(x = "Urbanisation",y = "Derivative (macroinvert. abundance)",tag = "e)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = d2b$derivative),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = d3b$derivative),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(dmin,dmax))

# panel f
Fig_2f<-ggplot(data = NULL,mapping = aes(x = d1c$data,y = d1c$derivative)) +
  theme_classic(base_size = 14) + 
  labs(x = "Winter temperature",y = "Derivative (bee mass loss)",tag = "f)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = d2c$derivative),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = d3c$derivative),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(dmin,dmax))

# panel g
Fig_2ga<-ggplot(data = rdiv_a,mapping = aes(x = data,y = rdiv)) +
  theme_classic(base_size = 14) + 
  labs(x = NULL,y = "Range (derivatives)",tag = "g)") + 
  geom_hline(yintercept = rdiv_a$Med,lty=2) +
  geom_line() + 
  geom_richtext(mapping = aes(x = 0.85,
                              y = rdiv_a$Med+0.25),
                size=4.5,
                label.color = NA,
                label = paste("RDiv^Med =",paste0(round(rdiv_a$Med,digits = 2)))) +
  lims(y = c(rmin,rmax))
Fig_2gb<-ggplot(data = rdiv_a,mapping = aes(x = data,y = sign)) +
  theme_bw(base_size = 14)+
  labs(x = "Spring frost",y = "Sign") + 
  geom_line() + 
  lims(y = c(smin,smax))
Fig_2gb<-Fig_2gb + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# panel h
Fig_2ha<-ggplot(data = rdiv_b,mapping = aes(x = data,y = rdiv)) +
  theme_classic(base_size = 14) + 
  labs(x = NULL,y = "Range (derivatives)",tag = "h)") + 
  geom_hline(yintercept = rdiv_b$Med,lty=2) +
  geom_line() + 
  geom_richtext(mapping = aes(x = 0.85,
                              y = rdiv_b$Med-0.25),
                size=4.5,
                label.color = NA,
                label = paste("RDiv^Med =",paste0(round(rdiv_b$Med,digits = 2)))) +
  lims(y = c(rmin,rmax))
Fig_2hb<-ggplot(data = rdiv_b,mapping = aes(x = data,y = sign)) +
  theme_bw(base_size = 14)+
  labs(x = "Urbanisation",y = "Sign") + 
  geom_line() + 
  lims(y = c(smin,smax))
Fig_2hb<-Fig_2hb + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# panel i
Fig_2ia<-ggplot(data = rdiv_c,mapping = aes(x = data,y = rdiv)) +
  theme_classic(base_size = 14) + 
  labs(x = NULL,y = "Range (derivatives)",tag = "i)") + 
  geom_hline(yintercept = rdiv_c$Med,lty=2) +
  geom_line() + 
  geom_richtext(mapping = aes(x = 0.85,
                              y = rdiv_c$Med+0.25),
                size=4.5,
                label.color = NA,
                label = paste("RDiv^Med =",paste0(round(rdiv_c$Med,digits = 2)))) +
  lims(y = c(rmin,rmax))
Fig_2ib<-ggplot(data = rdiv_c,mapping = aes(x = data,y = sign)) +
  theme_bw(base_size = 14)+
  labs(x = "Winter temperature",y = "Sign") + 
  geom_line() + 
  lims(y = c(smin,smax))
Fig_2ib<-Fig_2ib + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

(Fig_2a + Fig_2b + Fig_2c)/(Fig_2d + Fig_2e + Fig_2f)/(Fig_2ga + Fig_2ha + Fig_2ia)/(Fig_2gb + Fig_2hb + Fig_2ib) + plot_layout(heights = c(3,3,3,3))
```

Next, we'll produce *Figure 3* to look at _nonlinear_ performance-environment relationships: 

```{r}
# Y value range
ymax<-max(y1d,y2d,y3d,y1e,y2e,y3e,y1f,y2f,y3f);ymin<-min(y1d,y2d,y3d,y1e,y2e,y3e,y1f,y2f,y3f)
dmax<-max(d1d$derivative,d2d$derivative,d3d$derivative,d1e$derivative,d2e$derivative,d3e$derivative,d1f$derivative,d2f$derivative,d3f$derivative)
dmin<-min(d1d$derivative,d2d$derivative,d3d$derivative,d1e$derivative,d2e$derivative,d3e$derivative,d1f$derivative,d2f$derivative,d3f$derivative)
rmax<-max(rdiv_d$rdiv,rdiv_e$rdiv,rdiv_f$rdiv);rmin<-0
smax<-1;smin<-0

# panel a
Fig_3a<-ggplot(data = NULL,mapping = aes(x = x,y = y1d)) +
  theme_classic(base_size = 14) + 
  labs(x = "Flowering plant abundance",y = "Flowering plant rate of increase",title = "Low response diversity",tag = "a)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = y2d),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = y3d),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(ymin,ymax))

# panel b
Fig_3b<-ggplot(data = NULL,mapping = aes(x = x,y = y1e)) +
  theme_classic(base_size = 14) + 
  labs(x = "Grazing pressure",y = "Seedling establishment",title = "Medium response diversity",tag = "b)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = y2e),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = y3e),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(ymin,ymax))

# panel c
Fig_3c<-ggplot(data = NULL,mapping = aes(x = x,y = y1f)) +
  theme_classic(base_size = 14) + 
  labs(x = "Fire frequency",y = "Tree density",title = "High response diversity",tag = "c)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = y2f),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = y3f),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(ymin,ymax))

# panel d
Fig_3d<-ggplot(data = NULL,mapping = aes(x = d1d$data,y = d1d$derivative)) +
  theme_classic(base_size = 14) + 
  labs(x = "Flowering plant abundance",y = "Derivative (rate of increase)",tag = "d)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = d2d$derivative),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = d3d$derivative),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(dmin,dmax))

# panel e
Fig_3e<-ggplot(data = NULL,mapping = aes(x = d1e$data,y = d1e$derivative)) +
  theme_classic(base_size = 14) + 
  labs(x = "Grazing pressure",y = "Derivative (seedling establish.)",tag = "e)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = d2e$derivative),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = d3e$derivative),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(dmin,dmax))

# panel f
Fig_3f<-ggplot(data = NULL,mapping = aes(x = d1f$data,y = d1f$derivative)) +
  theme_classic(base_size = 14) + 
  labs(x = "Fire frequency",y = "Derivative (tree density)",tag = "f)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = d2f$derivative),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = d3f$derivative),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(dmin,dmax))

# panel g
Fig_3ga<-ggplot(data = rdiv_d,mapping = aes(x = data,y = rdiv)) +
  theme_classic(base_size = 14) + 
  labs(x = NULL,y = "Range (derivatives)",tag = "g)") + 
  geom_hline(yintercept = rdiv_d$Med,lty=2) +
  geom_line() + 
  geom_richtext(mapping = aes(x = 0.85,
                              y = rdiv_d$Med+1.25),
                size=4.5,
                label.color = NA,
                label = paste("RDiv^Med =",paste0(round(rdiv_d$Med,digits = 2)))) +
  lims(y = c(rmin,rmax))
Fig_3gb<-ggplot(data = rdiv_d,mapping = aes(x = data,y = sign)) +
  theme_bw(base_size = 14)+
  labs(x = "Flowering plant abundance",y = "Sign") + 
  geom_line() + 
  lims(y = c(smin,smax))
Fig_3gb<-Fig_3gb + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# panel h
Fig_3ha<-ggplot(data = rdiv_e,mapping = aes(x = data,y = rdiv)) +
  theme_classic(base_size = 14) + 
  labs(x = NULL,y = "Range (derivatives)",tag = "h)") + 
  geom_hline(yintercept = rdiv_e$Med,lty=2) +
  geom_line() + 
  geom_richtext(mapping = aes(x = 0.85,
                              y = rdiv_e$Med+1.25),
                size=4.5,
                label.color = NA,
                label = paste("RDiv^Med =",paste0(round(rdiv_e$Med,digits = 2)))) +
  lims(y = c(rmin,rmax))
Fig_3hb<-ggplot(data = rdiv_e,mapping = aes(x = data,y = sign)) +
  theme_bw(base_size = 14)+
  labs(x = "Grazing pressure",y = "Sign") + 
  geom_line() + 
  lims(y = c(smin,smax))
Fig_3hb<-Fig_3hb + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# panel i
Fig_3ia<-ggplot(data = rdiv_f,mapping = aes(x = data,y = rdiv)) +
  theme_classic(base_size = 14) + 
  labs(x = NULL,y = "Range (derivatives)",tag = "i)") + 
  geom_hline(yintercept = rdiv_f$Med,lty=2) +
  geom_line() + 
  geom_richtext(mapping = aes(x = 0.85,
                              y = rdiv_f$Med-1.25),
                size=4.5,
                label.color = NA,
                label = paste("RDiv^Med =",paste0(round(rdiv_f$Med,digits = 2)))) +
  lims(y = c(rmin,rmax))
Fig_3ib<-ggplot(data = rdiv_f,mapping = aes(x = data,y = sign)) +
  theme_bw(base_size = 14)+
  labs(x = "Fire frequency",y = "Sign") + 
  geom_line() + 
  lims(y = c(smin,smax))
Fig_3ib<-Fig_3ib + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

(Fig_3a + Fig_3b + Fig_3c)/(Fig_3d + Fig_3e + Fig_3f)/(Fig_3ga + Fig_3ha + Fig_3ia)/(Fig_3gb + Fig_3hb + Fig_3ib) + plot_layout(heights = c(3,3,3,3))

```

# Leary & Petchey (2009) reanalysis

This section reanalyses the data from Leary & Petchey (2009, _Journal of Animal Ecology_) using the framework we present above.

```{r}
#rm(list = ls())
r_vals <- read_csv(here("data/Leary_and_Petchey_r_values.csv")) %>%
  mutate(parameter = "r")
K_vals <- read_csv(here("data/Leary_and_Petchey_K_values.csv")) %>%
  mutate(x = log10(x), parameter = "log10_K")
rK_vals <- rbind(r_vals, K_vals) %>%
  rename(value = x)
rm(r_vals, K_vals)
```

The reanalysis is based on the range of the first derivatives and including information on whether those first derivatives span zero (and by how much).

```{r}
# get subsets of the data for measuring response diversity
sp1_r<-rK_vals[rK_vals$species %in% 'tetrahymena' & rK_vals$parameter %in% 'r',]
sp2_r<-rK_vals[rK_vals$species %in% 'loxocephallus' & rK_vals$parameter %in% 'r',]
sp3_r<-rK_vals[rK_vals$species %in% 'colpidium' & rK_vals$parameter %in% 'r',]
sp4_r<-rK_vals[rK_vals$species %in% 'paramecium' & rK_vals$parameter %in% 'r',]
sp1_K<-rK_vals[rK_vals$species %in% 'tetrahymena' & rK_vals$parameter %in% 'log10_K',]
sp2_K<-rK_vals[rK_vals$species %in% 'loxocephallus' & rK_vals$parameter %in% 'log10_K',]
sp3_K<-rK_vals[rK_vals$species %in% 'colpidium' & rK_vals$parameter %in% 'log10_K',]
sp4_K<-rK_vals[rK_vals$species %in% 'paramecium' & rK_vals$parameter %in% 'log10_K',]

# using k=5 to avoid the error when the predictor variable has fewer levels than k in model spec. <https://stackoverflow.com/a/62914481>, but maybe Dave's markdown will have a better solution (I have limited experience with GAMs ~Sam)
m1_r<-gam(data = sp1_r,value~s(temperature,k=5))
m2_r<-gam(data = sp2_r,value~s(temperature,k=5))
m3_r<-gam(data = sp3_r,value~s(temperature,k=5))
m4_r<-gam(data = sp4_r,value~s(temperature,k=5))
m1_K<-gam(data = sp1_K,value~s(temperature,k=5))
m2_K<-gam(data = sp2_K,value~s(temperature,k=5))
m3_K<-gam(data = sp3_K,value~s(temperature,k=5))
m4_K<-gam(data = sp4_K,value~s(temperature,k=5))

# get first derivatives
d1_r<-derivatives(m1_r)
d2_r<-derivatives(m2_r)
d3_r<-derivatives(m3_r)
d4_r<-derivatives(m4_r)
d1_K<-derivatives(m1_K)
d2_K<-derivatives(m2_K)
d3_K<-derivatives(m3_K)
d4_K<-derivatives(m4_K)

# calculate response diversity for intrinsic rate of increase (r)
rdiv_r<-data.frame('temperature' = d1_r$data, 'tetrahymena' = d1_r$derivative, 'loxocephallus' = d2_r$derivative, 'colpidium' = d3_r$derivative, 'paramecium' = d4_r$derivative)
rdiv_r$rdiv<-apply(rdiv_r[,c(2:5)], 1, resp_div, stat = "range", sign_sens = F)
rdiv_r$sign<-apply(rdiv_r[,c(2:5)], 1, resp_div, stat = "range", sign_sens = T)
rdiv_r$Med<-median(rdiv_r$rdiv)

# calculate response diversity for carrying capacity (K)
rdiv_K<-data.frame('temperature' = d1_K$data, 'tetrahymena' = d1_K$derivative, 'loxocephallus' = d2_K$derivative, 'colpidium' = d3_K$derivative, 'paramecium' = d4_K$derivative)
rdiv_K$rdiv<-apply(rdiv_K[,c(2:5)], 1, resp_div, stat = "range", sign_sens = F)
rdiv_K$sign<-apply(rdiv_K[,c(2:5)], 1, resp_div, stat = "range", sign_sens = T)
rdiv_K$Med<-median(rdiv_K$rdiv)

```

We can then plot a figure similar to Figures 2 and 3, but instead based on the real data from Leary & Petchey (2009). This is Figure 4 (or Box Figure 1) from the manuscript.

```{r}
smax<-1;smin<-0

# panel a
Fig_4a<-ggplot(data = sp1_r,mapping = aes(x = temperature,y = value)) +
              theme_classic(base_size = 14) + 
              labs(x = "Temperature",y = "Intrinsic rate of increase (r)",tag = "a)") + 
              geom_point(col = Isfahan1[[1]][5],size = 2,shape = 1) +
              geom_point(aes(y = sp2_r$value),col = Isfahan1[[1]][4],size = 2,shape = 1) +
              geom_point(aes(y = sp3_r$value),col = Isfahan1[[1]][3],size = 2,shape = 1) +
              geom_point(aes(y = sp4_r$value),col = Isfahan1[[1]][2],size = 2,shape = 1) +
              geom_smooth(col = Isfahan1[[1]][5]) + 
              geom_smooth(aes(y = sp2_r$value),col = Isfahan1[[1]][4]) + 
              geom_smooth(aes(y = sp3_r$value),col = Isfahan1[[1]][3]) + 
              geom_smooth(aes(y = sp4_r$value),col = Isfahan1[[1]][2])

# panel b
Fig_4b<-ggplot(data = sp1_K,mapping = aes(x = temperature,y = value)) +
              theme_classic(base_size = 14) + 
              labs(x = "Temperature",y = "log10 carrying capacity (K)",tag = "b)") + 
              geom_point(col = Isfahan1[[1]][5],size = 2,shape = 1) +
              geom_point(aes(y = sp2_K$value),col = Isfahan1[[1]][4],size = 2,shape = 1) +
              geom_point(aes(y = sp3_K$value),col = Isfahan1[[1]][3],size = 2,shape = 1) +
              geom_point(aes(y = sp4_K$value),col = Isfahan1[[1]][2],size = 2,shape = 1) +
              geom_smooth(col = Isfahan1[[1]][5]) + 
              geom_smooth(aes(y = sp2_K$value),col = Isfahan1[[1]][4]) + 
              geom_smooth(aes(y = sp3_K$value),col = Isfahan1[[1]][3]) + 
              geom_smooth(aes(y = sp4_K$value),col = Isfahan1[[1]][2])

# panel c
Fig_4c<-ggplot(data = d1_r,mapping = aes(x = data,y = derivative)) +
  theme_classic(base_size = 14) + 
  labs(x = "Temperature",y = "Derivative (rate of increase)",tag = "c)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][5]) + 
  geom_line(aes(y = d2_r$derivative),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = d3_r$derivative),
            col = Isfahan1[[1]][3]) + 
  geom_line(aes(y = d4_r$derivative),
            col = Isfahan1[[1]][2])

# panel d
Fig_4d<-ggplot(data = d1_K,mapping = aes(x = data,y = derivative)) +
  theme_classic(base_size = 14) + 
  labs(x = "Temperature",y = "Derivative (carrying capacity)",tag = "d)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][5]) + 
  geom_line(aes(y = d2_K$derivative),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = d3_K$derivative),
            col = Isfahan1[[1]][3]) + 
  geom_line(aes(y = d4_K$derivative),
            col = Isfahan1[[1]][2])

# panel e
Fig_4ea<-ggplot(data = rdiv_r,mapping = aes(x = temperature,y = rdiv)) +
  theme_classic(base_size = 14) + 
  labs(x = NULL,y = "Range (derivatives)",tag = "e)") + 
  geom_hline(yintercept = rdiv_r$Med,lty=2) +
  geom_line() + 
  geom_richtext(mapping = aes(x = 19,
                              y = rdiv_r$Med+0.05),
                size=4.5,
                label.color = NA,
                label = paste("RDiv^Med =",paste0(round(rdiv_r$Med,digits = 2))))
Fig_4eb<-ggplot(data = rdiv_r,mapping = aes(x = temperature,y = sign)) +
  theme_bw(base_size = 14)+
  labs(x = "Temperature",y = "Sign") + 
  geom_line() + 
  lims(y = c(smin,smax))
Fig_4eb<-Fig_4eb + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# panel f
Fig_4fa<-ggplot(data = rdiv_K,mapping = aes(x = temperature,y = rdiv)) +
  theme_classic(base_size = 14) + 
  labs(x = NULL,y = "Range (derivatives)",tag = "f)") + 
  geom_hline(yintercept = rdiv_K$Med,lty=2) +
  geom_line() + 
  geom_richtext(mapping = aes(x = 19,
                              y = rdiv_K$Med+0.05),
                size=4.5,
                label.color = NA,
                label = paste("RDiv^Med =",paste0(round(rdiv_K$Med,digits = 2))))
Fig_4fb<-ggplot(data = rdiv_K,mapping = aes(x = temperature,y = sign)) +
  theme_bw(base_size = 14)+
  labs(x = "Temperature",y = "Sign") + 
  geom_line() + 
  lims(y = c(smin,smax))
Fig_4fb<-Fig_4fb + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

(Fig_4a + Fig_4b)/(Fig_4c + Fig_4d)/(Fig_4ea + Fig_4fa)/(Fig_4eb + Fig_4fb) + plot_layout(heights = c(3,3,3,3))

```

# Results of the systematic review

Here are the results from the systematic review conducted by Samuel RP-J Ross in December 2021-January 2022. Columns are as follows: 

*Date* = Date on which paper was included in review.
*WoS_search* = Search string for reproducing systematic review (NA indicates papers not returned in WoS results).
*Handled_by* = Intitials of author handling each paper during screening (SRP-JR = Samuel RP-J Ross).
*Included* = Binary, included (1) or not (0) as an empirical paper that measures response diversity after all screening.
*Authors* = Short form author list of each article. 
*Title* = Title of article.
*Journal* = Journal of article publication. 
*Year* = Year of publication. 
*Vol* = Volume of publication. 
*Issue* = Issue of publication. 
*Pg_start* = First page number of publication.
*Pg_end* = Last page number of publication.
*Article_ID* = Identifier of articles without page numbers.
*DOI* = Digital object identifier (DOI) of article. 
*Empirical_study* = Does the study use empirical data? 1 = yes, 0 = no, 0.5 = sort of (Theory papers etc.).
*Measures_RD* = Does the empirical (or theoretical) study measure response diversity? 1 = yes, 0 = no, 0.5 = sort of.
*RD_traits* = For papers that measure response diversity, do they measure functional response trait diversity? 0 = no, 0.5 = sort of, FDis = yes, using Functional Dispersion, RaoQ = yes, using Rao's Quadratic Entropy.
*RD_Int_term* = For papers that measure response diversity, do they measure an interaction term between species responding to an environmental variable? 0 = no, 0.5 = sort of, 1 = yes.
*RD_Other* = For papers that measure response diversity, do they take another approach (i.e. not traits or interaction terms)? 0 = no, 1 = yes. 
*Method_Description* = Short written description to help clarify method (see individual articles for more details).
*Notes* = Any remaining comments from SRP-JR to help justify inclusion/exclusion, or additional comments.

```{r}
review <- read_csv(here("data/WoS_results.csv"))
review
```

