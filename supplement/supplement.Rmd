---
title: Supplementary information to report "How to measure response diversity"
author: "Samuel R.P-J. Ross1, Owen L. Petchey, Takehiro Sasaki, David Armitage"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
---

```{r include = FALSE, echo = FALSE}
knitr::opts_chunk$set(include = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      echo = FALSE)
```

```{r}
rm(list = ls())
library(tidyverse)
#library(microxanox)
library(patchwork)
library(mgcv)
library(gratia)
library(here)
Isfahan1 <- list(c("#4e3910", "#845d29", "#d8c29d", "#4fb6ca", "#178f92", "#175f5d", "#1d1f54"), c(5, 2, 4, 6, 1, 7, 3), colorblind=TRUE) # colour palette
range01 <- function(x){(x-min(x))/(max(x)-min(x))} # function for standardising range 0-1
```

# Introduction

To be written.

# Two dimensions of response diversity

I created communities containing species, and gave each species $i$ a value for the first derivative of it's response to an environmental variable ($x_i$).

I think there are two dimensions (at least) of the diversity of these values. First, the spread of the distribution, which is what we already use in the ms. Here I use the standard deviation, i.e., sd($x$). This is not affected by the mean of $x$, i.e. is not affect by if the values of $x$ span zero or do not span zero. (I use sd($x$) rather than CV($x$) because the CV is very much affected by values of mean($x$) close to zero.)

We do, however, (I think) consider it important if the values of $x$ include some negative and some positive values, and therefore should quantify this. I have done so with (sd($x$) - sd($|x|$)) / sd($x$). (I came up with this just by thinking... probably should have done some reading also.) This varies from zero to one, being zero when all $x$ have the same sign, and being one when there are only two unique values of $x$, say $x_1$ and $x_2$ and $x_1 = -x_2$. I'm  sure this is **not** the best thing to do, or even if it is very well justified, but it is at least independent of sd($x$), as a measure of this dimension should be, as is shown below in some examples.


```{r}
## Create the communities
num_spp <- c(2, 4, 8, 16)
max_minus_min <- seq(1, 10, length = 45)
mean <- seq(-10, 10, length = 49)
rd_vals <- function(num_spp, max_minus_min, mean) {
  seq(mean-max_minus_min/2, mean+max_minus_min/2, length = num_spp)
}
dd <- crossing(num_spp,
               max_minus_min,
               mean) %>%
  rowwise() %>%
  mutate(rd_vals = list(rd_vals(num_spp, max_minus_min, mean))) %>%
  unnest(cols = rd_vals) 

## calculate the diversity metrics
summary_stats <- dd %>%
  group_by(num_spp, max_minus_min, mean) %>%
  summarise(sd = sd(rd_vals),
            #cv = sd/mean(rd_vals),
            #cv_abs = sd/abs(mean(rd_vals)),
            #sd_abs_vals = sd(abs(rd_vals)),
            sign_sensitive = (sd - sd(abs(rd_vals))) / sd) %>%
  pivot_longer(names_to = "variable", values_to = "value", 4:5)

## wrangle the data for easier plotting
all_data <- dd %>%
  mutate(variable = "first_deriv_vals",
         value = rd_vals) %>%
  select(-rd_vals) %>%
  bind_rows(summary_stats) %>%
  mutate(variable = as_factor(variable))
```

## Communities varying only in spread

Here we look at communities that only vary in the spread of $x$ and that do not differ in the second dimension (overlap with zero). As expected, sd($x$) varies, but the measure of the overlap with zero does not. In the first example, all communities have equal overlap with zero (Fig. \@ref(fig:XXX1)) and in the second none of the communities overlap zero (Fig. \@ref(fig:XXX2)).

(ref:XXX1) Each column of dots corresponds to one community. Top panel shows the values of the first derivative of each of the species in the community. Middle is the sd($x$): the spread of the distribution. Bottom panel is the (sd($x$) - sd($|x|$)) / sd($x$) -- a measure of overlap with zero.

```{r XXX1,  include=TRUE, fig.cap='(ref:XXX1)', fig.align="center", fig.height=4, fig.width=4}
this_mean <- 0
this_num_spp <- 8
all_data %>%
  filter(mean == this_mean,
         num_spp == this_num_spp) %>%
  ggplot(aes(x = max_minus_min, y = value)) +
  geom_point() +
  geom_hline(yintercept = 0, lty="dashed") +
  facet_wrap( ~ variable, scales = "free_y", ncol = 1) +
  xlab("Range of first derivative values in community") 



```

(ref:XXX2) Each column of dots corresponds to one community. Top panel shows the values of the first derivative of each of the species in the community. Middle is the sd($x$): the spread of the distribution. Bottom panel is the (sd($x$) - sd($|x|$)) / sd($x$) -- a measure of overlap with zero.

```{r XXX2,  include=TRUE, fig.cap='(ref:XXX2)', fig.align="center", fig.height=4, fig.width=4}
this_mean <- 2.5
this_num_spp <- 8
all_data %>%
  filter(mean == this_mean,
         num_spp == this_num_spp,
         max_minus_min < 5) %>%
  ggplot(aes(x = max_minus_min, y = value)) +
  geom_point() +
  geom_hline(yintercept = 0, lty="dashed") +
  facet_wrap( ~ variable, scales = "free_y", ncol = 1) +
  xlab("Range of first derivative values in community")
```


## Communities varying only in overlap

Here we look at communities that only vary in the overlap of $x$ with zero, and that do not differ in spread. As expected, sd($x$) does not vary, but the measure of the overlap with zero does. It is zero while there is not overlap, then increases to a maximum when the mean is zero, and then decreases again (Fig. \@ref(fig:XXX3).

(ref:XXX3) Each column of dots corresponds to one community. Top panel shows the values of the first derivative of each of the species in the community. Middle is the sd($x$): the spread of the distribution. Bottom panel is the (sd($x$) - sd($|x|$)) / sd($x$) -- a measure of overlap with zero.

```{r XXX3,  include=TRUE, fig.cap='(ref:XXX3)', fig.align="center", fig.height=4, fig.width=4}
this_max_minus_min <- 5.5
this_num_spp <- 8
all_data %>%
  filter(max_minus_min == this_max_minus_min,
         num_spp == this_num_spp) %>%
  ggplot(aes(x = mean, y = value)) +
  geom_point() +
  geom_hline(yintercept = 0, lty="dashed") +
  facet_wrap( ~ variable, scales = "free_y", ncol = 1) +
  xlab("Mean of first derivative values in community") 
```




## Communities varying in both spread and overlap

Here we look at communities that vary in both spread and the overlap. As expected, sd($x$) increases but the overlap measure does not. Then the overlap measure increases as the amount of overlap with zero increases (Fig. \@ref(fig:XXX4).

(ref:XXX4) Each column of dots corresponds to one community. Top panel shows the values of the first derivative of each of the species in the community. Middle is the sd($x$): the spread of the distribution. Bottom panel is the (sd($x$) - sd($|x|$)) / sd($x$) -- a measure of overlap with zero. The data at values of less than 5 on the x-axis are the same as the data in Fig. \@ref(fig:XXX2).

```{r XXX4,  include=TRUE, fig.cap='(ref:XXX4)', fig.align="center", fig.height=4, fig.width=4}
this_mean <- 2.5
this_num_spp <- 8
all_data %>%
  filter(mean == this_mean,
         num_spp == this_num_spp) %>%
  ggplot(aes(x = max_minus_min, y = value)) +
  geom_point() +
  geom_hline(yintercept = 0, lty="dashed") +
  facet_wrap( ~ variable, scales = "free_y", ncol = 1) +
  xlab("Range of first derivative values in community")
```

## Varying number of species

This is the one I'm really not satisfied with. I think that either, or perhaps even both, dimension of response diversity should increase with species richness, but both actually decrease (Fig. \@ref(fig:XXX5)). I think this is why Kevin Gaston and I opted for the total branch length of the dendrogram of hierarchical clustering of the distance matrix -- it has this lovely property of only increasing (or staying the same) with increasing number of species. Anyway, I hand this over to you for contemplation, before continuing.

(ref:XXX5) Each column of dots corresponds to one community. Top panel shows the values of the first derivative of each of the species in the community. Middle is the sd($x$): the spread of the distribution. Bottom panel is the (sd($x$) - sd($|x|$)) / sd($x$) -- a measure of overlap with zero.

```{r XXX5,  include=TRUE, fig.cap='(ref:XXX5)', fig.align="center", fig.height=4, fig.width=4}
this_mean <- 0
this_num_spp <- 8
this_max_minus_min <- 5.5
all_data %>%
  filter(mean == this_mean,
         max_minus_min == this_max_minus_min) %>%
  ggplot(aes(x = num_spp, y = value)) +
  geom_point() +
  geom_hline(yintercept = 0, lty="dashed") +
  facet_wrap( ~ variable, scales = "free_y", ncol = 1) +
  xlab("Number of species") 



```


# Producing Figures 2-3 based on simulated data

This section will produce Figures 2-3 from the manuscript. The figures are inspired by a range of examples from the literature (see main text), but are based on simulated data.

First, we'll generate a series of simulated communities that have high, medium, or low response diversity to an environmental variable [x], based on correlated or uncorrelated responses, and responding either linearly or nonlinearly.

```{r}
# generate an environmental variable (x), as a simple sequence of numbers
x = seq(0, 1, length.out = 100)

# generate species with different responses to the environment 
# Linear responses:
y1a <- 0.8-1*x; y2a <- 0.75-1* x; y3a <-0.85-1*x # responses are similar in direction and magnitude (low response diversity)
y1b <- 0.5-0.2*x; y2b <- 0.75-1*x; y3b <-1-2.5*x # responses are similar in direction but not magnitude (medium response diversity)
y1c <- 0.6-0.75*x; y2c <- rev(y1c); y3c <- rep(0.35, length(x)) # responses are not similar in direction or magnitude (high response diversity)

# Nonlinear responses:
y1d <- range01(dnorm(x,0.5,0.3)); y2d <- range01(dnorm(x,0.475,0.3)); y3d <- range01(dnorm(x,0.525,0.3)) # responses are similar in direction and magnitude (low response diversity)
y1e <- range01(dnorm(x,0.5,0.3)); y2e <- range01(dnorm(x,0.2,0.3)); y3e <- range01(dnorm(x,0.8,0.3)) # responses are similar in direction but not magnitude (medium response diversity)
y1f <- exp(-3*x); y2f <- rev(y1f); y3f <- 1-(y1f+y2f) # responses are not similar in direction or magnitude (high response diversity)
```

We'll model these species-environment relationships using generalized additive models (GAMs).

```{r}
# model individual species~environment relationships using GAM
m1a <- gam(y1a~s(x)); m2a <- gam(y2a~s(x)); m3a <- gam(y3a~s(x))
m1b <- gam(y1b~s(x)); m2b <- gam(y2b~s(x)); m3b <- gam(y3b~s(x))
m1c <- gam(y1c~s(x)); m2c <- gam(y2c~s(x)); m3c <- gam(y3c~s(x))
m1d <- gam(y1d~s(x)); m2d <- gam(y2d~s(x)); m3d <- gam(y3d~s(x))
m1e <- gam(y1e~s(x)); m2e <- gam(y2e~s(x)); m3e <- gam(y3e~s(x))
m1f <- gam(y1f~s(x)); m2f <- gam(y2f~s(x)); m3f <- gam(y3f~s(x))
```

Then we calculate the first derivatives of these relationships.

```{r}
# calculate first derivatives from models
d1a <- derivatives(m1a); d2a <- derivatives(m2a); d3a <- derivatives(m3a)
d1b <- derivatives(m1b); d2b <- derivatives(m2b); d3b <- derivatives(m3b)
d1c <- derivatives(m1c); d2c <- derivatives(m2c); d3c <- derivatives(m3c)
d1d <- derivatives(m1d); d2d <- derivatives(m2d); d3d <- derivatives(m3d)
d1e <- derivatives(m1e); d2e <- derivatives(m2e); d3e <- derivatives(m3e)
d1f <- derivatives(m1f); d2f <- derivatives(m2f); d3f <- derivatives(m3f)
```

Then we'll measure response diversity using the approach above. 

*CODE HERE*


Now we have all the data required to produce the figures from the manuscript. First, we'll produce *Figure 2*, which looks at linear performance-environment relationships: 

```{r}
# Y value range
ymax<-max(y1a,y2a,y3a,y1b,y2b,y3b,y1c,y2c,y3c)
ymin<-min(y1a,y2a,y3a,y1b,y2b,y3b,y1c,y2c,y3c)
dmax<-max(d1a$derivative,d2a$derivative,d3a$derivative,d1b$derivative,d2b$derivative,d3b$derivative,d1c$derivative,d2c$derivative,d3c$derivative)
dmin<-min(d1a$derivative,d2a$derivative,d3a$derivative,d1b$derivative,d2b$derivative,d3b$derivative,d1c$derivative,d2c$derivative,d3c$derivative)

# panel a
Fig_2a<-ggplot(data = NULL,mapping = aes(x = x,y = y1a)) +
  theme_classic(base_size = 14) + 
  labs(x = "Spring frost",y = "Chlorophyll production",title = "Low response diversity",tag = "a)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = y2a),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = y3a),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(ymin,ymax))

# panel b
Fig_2b<-ggplot(data = NULL,mapping = aes(x = x,y = y1b)) +
  theme_classic(base_size = 14) + 
  labs(x = "Urbanisation",y = "Macroinvertebrate abundance",title = "Medium response diversity",tag = "b)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = y2b),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = y3b),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(ymin,ymax))

# panel c
Fig_2c<-ggplot(data = NULL,mapping = aes(x = x,y = y1c)) +
  theme_classic(base_size = 14) + 
  labs(x = "Winter temperature",y = "Bee mass loss",title = "High response diversity",tag = "c)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = y2c),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = y3c),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(ymin,ymax))

# plot of d(Y)~X for model a
Fig_2d<-ggplot(data = NULL,mapping = aes(x = d1a$data,y = d1a$derivative)) +
  theme_classic(base_size = 14) + 
  labs(x = "Spring frost",y = "Derivative (chlorophyll product.)",tag = "d)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = d2a$derivative),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = d3a$derivative),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(dmin,dmax))

# plot of d(Y)~X for model b
Fig_2e<-ggplot(data = NULL,mapping = aes(x = d1b$data,y = d1b$derivative)) +
  theme_classic(base_size = 14) + 
  labs(x = "Urbanisation",y = "Derivative (macroinvert. abundance)",tag = "e)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = d2b$derivative),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = d3b$derivative),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(dmin,dmax))

# plot of d(Y)~X for model c
Fig_2f<-ggplot(data = NULL,mapping = aes(x = d1c$data,y = d1c$derivative)) +
  theme_classic(base_size = 14) + 
  labs(x = "Winter temperature",y = "Derivative (bee mass loss)",tag = "f)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = d2c$derivative),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = d3c$derivative),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(dmin,dmax))

(Fig_2a + Fig_2b + Fig_2c)/(Fig_2d + Fig_2e + Fig_2f)
```

Next, we'll produce *Figure 3* to look at _nonlinear_ performance-environment relationships: 

```{r}
# Y value range
ymax<-max(y1d,y2d,y3d,y1e,y2e,y3e,y1f,y2f,y3f)
ymin<-min(y1d,y2d,y3d,y1e,y2e,y3e,y1f,y2f,y3f)
dmax<-max(d1d$derivative,d2d$derivative,d3d$derivative,d1e$derivative,d2e$derivative,d3e$derivative,d1f$derivative,d2f$derivative,d3f$derivative)
dmin<-min(d1d$derivative,d2d$derivative,d3d$derivative,d1e$derivative,d2e$derivative,d3e$derivative,d1f$derivative,d2f$derivative,d3f$derivative)

# panel a
Fig_3a<-ggplot(data = NULL,mapping = aes(x = x,y = y1d)) +
  theme_classic(base_size = 14) + 
  labs(x = "Flowering plant abundance",y = "Flowering plant rate of increase",title = "Low response diversity",tag = "a)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = y2d),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = y3d),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(ymin,ymax))

# panel b
Fig_3b<-ggplot(data = NULL,mapping = aes(x = x,y = y1e)) +
  theme_classic(base_size = 14) + 
  labs(x = "Grazing pressure",y = "Seedling establishment",title = "Medium response diversity",tag = "b)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = y2e),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = y3e),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(ymin,ymax))

# panel c
Fig_3c<-ggplot(data = NULL,mapping = aes(x = x,y = y1f)) +
  theme_classic(base_size = 14) + 
  labs(x = "Fire frequency",y = "Tree density",title = "High response diversity",tag = "c)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = y2f),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = y3f),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(ymin,ymax))

# plot of d(Y)~X for model a
Fig_3d<-ggplot(data = NULL,mapping = aes(x = d1d$data,y = d1d$derivative)) +
  theme_classic(base_size = 14) + 
  labs(x = "Flowering plant abundance",y = "Derivative (rate of increase)",tag = "d)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = d2d$derivative),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = d3d$derivative),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(dmin,dmax))

# plot of d(Y)~X for model b
Fig_3e<-ggplot(data = NULL,mapping = aes(x = d1e$data,y = d1e$derivative)) +
  theme_classic(base_size = 14) + 
  labs(x = "Grazing pressure",y = "Derivative (seedling establish.)",tag = "e)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = d2e$derivative),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = d3e$derivative),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(dmin,dmax))

# plot of d(Y)~X for model c
Fig_3f<-ggplot(data = NULL,mapping = aes(x = d1f$data,y = d1f$derivative)) +
  theme_classic(base_size = 14) + 
  labs(x = "Fire frequency",y = "Derivative (tree density)",tag = "f)") + 
  geom_hline(yintercept = 0,
             lty=2) +
  geom_line(col = Isfahan1[[1]][2]) + 
  geom_line(aes(y = d2f$derivative),
            col = Isfahan1[[1]][4]) + 
  geom_line(aes(y = d3f$derivative),
            col = Isfahan1[[1]][6]) + 
  lims(y = c(dmin,dmax))

(Fig_3a + Fig_3b + Fig_3c)/(Fig_3d + Fig_3e + Fig_3f)
```

# Leary & Petchey (2009) reanalysis

This so far only reads in the r and K data and plots their response to temperature for the four species.

```{r}
rm(list = ls())
r_vals <- read_csv(here("data/Leary_and_Petchey_r_values.csv")) %>%
  mutate(parameter = "r")
K_vals <- read_csv(here("data/Leary_and_Petchey_K_values.csv")) %>%
  mutate(x = log10(x), parameter = "log10_K")
rK_vals <- rbind(r_vals, K_vals) %>%
  rename(value = x)
rm(r_vals, K_vals)
```

```{r}
rK_vals %>%
ggplot(aes(x = temperature, y = value, col = species)) +
  geom_point() +
  geom_smooth() +
  facet_wrap( ~ parameter, scales = "free", nrow = 2) 
```


# Results of the systematic review

Here are the results from the systematic review conducted by Samuel RP-J Ross in December 2021-January 2022. Columns are as follows: 

*Date* = Date on which paper was included in review.
*WoS_search* = Search string for reproducing systematic review (NA indicates papers not returned in WoS results).
*Handled_by* = Intitials of author handling each paper during screening (SRP-JR = Samuel RP-J Ross).
*Included* = Binary, included (1) or not (0) as an empirical paper that measures response diversity after all screening.
*Authors* = Short form author list of each article. 
*Title* = Title of article.
*Journal* = Journal of article publication. 
*Year* = Year of publication. 
*Vol* = Volume of publication. 
*Issue* = Issue of publication. 
*Pg_start* = First page number of publication.
*Pg_end* = Last page number of publication.
*Article_ID* = Identifier of articles without page numbers.
*DOI* = Digital object identifier (DOI) of article. 
*Empirical_study* = Does the study use empirical data? 1 = yes, 0 = no, 0.5 = sort of (Theory papers etc.).
*Measures_RD* = Does the empirical (or theoretical) study measure response diversity? 1 = yes, 0 = no, 0.5 = sort of.
*RD_traits* = For papers that measure response diversity, do they measure functional response trait diversity? 0 = no, 0.5 = sort of, FDis = yes, using Functional Dispersion, RaoQ = yes, using Rao's Quadratic Entropy.
*RD_Int_term* = For papers that measure response diversity, do they measure an interaction term between species responding to an environmental variable? 0 = no, 0.5 = sort of, 1 = yes.
*RD_Other* = For papers that measure response diversity, do they take another approach (i.e. not traits or interaction terms)? 0 = no, 1 = yes. 
*Method_Description* = Short written description to help clarify method (see individual articles for more details).
*Notes* = Any remaining comments from SRP-JR to help justify inclusion/exclusion, or additional comments.

```{r}
review <- read_csv(here("data/WoS_results.csv"))
review
```

